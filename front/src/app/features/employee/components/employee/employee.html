<div class="page-container">
  <div class="page-content">
    @if (isLoading()) {
      <p>Loading employee details...</p>
    } @else if (employee()) {
      <!-- Employee Header -->
      <div class="employee-header text-center mb-3">
        <h1>{{ employee()!.username }}</h1>
        <div class="employee-stats d-flex justify-content-center gap-4">
          <div class="stat-card vacation-days-card" (click)="openVacationDaysModal()">
            <h3>{{ employee()!.vacationDays }}</h3>
            <p class="text-muted">Vacation Days</p>
          </div>
        </div>
      </div>

      <!-- Assignments Section -->
      <div class="assignments-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="section-header mb-0">Project Assignments</h2>
          <button type="button" class="btn btn-primary" (click)="openAssignModal()">
            Assign to Project
          </button>
        </div>

        @if (isLoadingAssignments()) {
          <p>Loading assignments...</p>
        } @else if (employeeAssignments()) {
          @if (employeeAssignments()!.content.length === 0) {
            <div class="no-assignments">
              <p>This employee is not assigned to any projects.</p>
            </div>
          } @else {
            <app-data-table
              [data]="employeeAssignments()!"
              [config]="assignmentTableConfig"
              (action)="onTableAction($event)"
            />
          }
        } @else {
          <div class="no-assignments">
            <p>This employee is not assigned to any projects.</p>
          </div>
        }
      </div>
    } @else {
      <div class="error-message text-center">
        <h2>Employee not found</h2>
        <p class="text-muted">The requested employee could not be loaded.</p>
      </div>
    }
  </div>
</div>

<!-- Unassign Confirmation Modal -->
<ng-template #unassignModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Confirm Unassignment</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to unassign <strong>{{ employee()?.username }}</strong> from project <strong>{{ selectedAssignment?.project?.name }}</strong>?</p>
    <p class="text-muted">This action cannot be undone.</p>
  </div>
  <div class="modal-footer d-flex justify-content-between">
    <button type="button" class="btn btn-outline-primary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="modal.close('confirm')">Unassign</button>
  </div>
</ng-template>

<!-- Assign to Project Modal -->
<ng-template #assignModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Assign to Project</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3">
      <label class="form-label">Project</label>
      @if (isLoadingProjects()) {
        <p>Loading projects...</p>
      } @else if (availableProjects() && availableProjects()!.length > 0) {
        <div class="project-list">
          @for (project of availableProjects(); track project.id) {
            <div class="project-option"
                 [class.selected]="selectedProjectId === project.id"
                 (click)="selectedProjectId = project.id">
              <div class="project-info">
                <strong>{{ project.name }}</strong>
                <p class="text-muted mb-0">{{ project.description }}</p>
              </div>
            </div>
          }
        </div>
      } @else {
        <p class="text-muted">No available projects to assign.</p>
      }
    </div>

    <div class="mb-3">
      <label for="hourRate" class="form-label">Hour Rate</label>
      <input type="number" class="form-control" id="hourRate"
             [(ngModel)]="assignmentHourRate" min="0" step="0.01"
             placeholder="Enter hour rate"
             [class.is-invalid]="assignmentHourRate !== null && assignmentHourRate < 0">
      @if (assignmentHourRate !== null && assignmentHourRate < 0) {
        <div class="invalid-feedback">
          Hour rate must be greater than or equal to 0.
        </div>
      }
    </div>
  </div>
  <div class="modal-footer d-flex justify-content-between">
    <button type="button" class="btn btn-outline-primary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary"
            [disabled]="!selectedProjectId || !assignmentHourRate || assignmentHourRate < 0 || isAssigning()"
            (click)="modal.close('confirm')">
      @if (isAssigning()) {
        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
      }
      Assign
    </button>
  </div>
</ng-template>

<!-- Vacation Days Edit Modal -->
<ng-template #vacationDaysModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Edit Vacation Days</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3">
      <label for="vacationDays" class="form-label">Vacation Days for <strong>{{ employee()?.username }}</strong></label>
      <input type="number" class="form-control" id="vacationDays"
             [(ngModel)]="newVacationDays" min="0"
             placeholder="Enter vacation days">
      <div class="form-text">Current vacation days: {{ employee()?.vacationDays }}</div>
    </div>
  </div>
  <div class="modal-footer d-flex justify-content-between">
    <button type="button" class="btn btn-outline-primary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary"
            [disabled]="!newVacationDays && newVacationDays !== 0 || isUpdatingVacationDays()"
            (click)="modal.close('confirm')">
      @if (isUpdatingVacationDays()) {
        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
      }
      Update
    </button>
  </div>
</ng-template>
